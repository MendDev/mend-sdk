"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class t extends Error{constructor(e,s,i){super(e),this.name="MendError",this.code=s,this.status=i,Object.setPrototypeOf(this,t.prototype)}}const e={SDK_CONFIG:"SDK_CONFIG",AUTH_MISSING_TOKEN:"AUTH_MISSING_TOKEN",AUTH_MFA_REQUIRED:"AUTH_MFA_REQUIRED",AUTH_INVALID_MFA:"AUTH_INVALID_MFA",ORG_NOT_FOUND:"ORG_NOT_FOUND",HTTP_ERROR:"HTTP_ERROR"};class s{constructor(t){var e;this.apiEndpoint=t.apiEndpoint.replace(/\/$/,""),this.defaultHeaders=null!==(e=t.defaultHeaders)&&void 0!==e?e:{}}async fetch(s,i,a,r={},n={},o){const d=Object.keys(r).length?"?"+new URLSearchParams(r).toString():"",h=this.apiEndpoint+i+d,l={"Content-Type":"application/json",Accept:"application/json",...this.defaultHeaders,...n},c=await fetch(h,{method:s,headers:l,body:a?JSON.stringify(a):void 0,signal:o});if(!c.ok)throw new t(`HTTP ${c.status} â€“ ${c.statusText}`,e.HTTP_ERROR,c.status);const u=await c.text();return u?JSON.parse(u):void 0}}class i{constructor(){this.mutex=Promise.resolve()}async lock(t){let e;const s=new Promise((t=>{e=t})),i=this.mutex;this.mutex=this.mutex.then((()=>s)),await i;try{return await t()}finally{e()}}}class a{constructor(a){var r,n;if(this.authMutex=new i,this.activeOrgId=null,this.availableOrgs=null,this.jwt=null,this.jwtExpiresAt=0,!(null==a?void 0:a.apiEndpoint)||!(null==a?void 0:a.email)||!(null==a?void 0:a.password))throw new t("apiEndpoint, email and password are required",e.SDK_CONFIG);this.httpClient=(n={apiEndpoint:a.apiEndpoint,defaultHeaders:a.defaultHeaders},new s(n)),this.email=a.email,this.password=a.password,this.orgId=a.orgId,this.mfaCode=a.mfaCode,this.tokenTTL=null!==(r=a.tokenTTL)&&void 0!==r?r:55}async authenticate(){const s=await this.httpClient.fetch("POST","/session",{email:this.email,password:this.password},{},{});if(s.token)await this.completeLogin(s);else{if(void 0===this.mfaCode)throw new t("JWT not returned by /session",e.AUTH_MISSING_TOKEN);await this.submitMfaCode(this.mfaCode)}}async completeLogin(s){var i,a;const r=s.token;if(!r)throw new t("JWT not returned by /session",e.AUTH_MISSING_TOKEN);this.jwt=r,this.jwtExpiresAt=Date.now()+6e4*this.tokenTTL;const n=null==s?void 0:s.payload;if(Array.isArray(null==n?void 0:n.orgs)&&(this.availableOrgs=n.orgs),void 0!==this.orgId)await this.switchOrg(this.orgId);else{if(!this.availableOrgs){const t=await this.listOrgs();this.availableOrgs=Array.isArray(null==t?void 0:t.payload)?t.payload:null===(i=null==t?void 0:t.payload)||void 0===i?void 0:i.orgs}if(Array.isArray(this.availableOrgs)&&1===this.availableOrgs.length){const t=this.availableOrgs[0],e=null!==(a=t.id)&&void 0!==a?a:t.orgId;e&&await this.switchOrg(e)}}}async ensureAuth(){this.jwt&&Date.now()<this.jwtExpiresAt||await this.authMutex.lock((async()=>{(!this.jwt||Date.now()>=this.jwtExpiresAt)&&await this.authenticate()}))}async request(t,e,s,i,a){await this.ensureAuth();const r={};return this.jwt&&(r["X-Access-Token"]=this.jwt),this.httpClient.fetch(t,e,s,i||{},r,a)}async getOrg(t,e){return this.request("GET",`/org/${t}`,void 0,void 0,e)}async getUser(t,e){return this.request("GET",`/user/${t}`,void 0,void 0,e)}async searchPatients(t={},e){return this.request("GET","/patient",void 0,t,e)}async getPatient(t,e){return this.request("GET",`/patient/${t}`,void 0,void 0,e)}async getPatientAssessmentScores(t,e){return this.request("GET",`/patient/${t}/assessment-scores`,void 0,void 0,e)}async createPatient(t,e=!1,s){const i=e?"/patient/force":"/patient";return this.request("POST",i,t,void 0,s)}async updatePatient(t,e,s=!1,i){const a=s?`/patient/${t}/force`:`/patient/${t}`;return this.request("PUT",a,e,void 0,i)}async deletePatient(t,e){return this.request("DELETE",`/patient/${t}`,void 0,void 0,e)}async getAppointment(t,e){return this.request("GET",`/appointment/${t}`,void 0,void 0,e)}async createAppointment(t,e){return this.request("POST","/appointment",t,void 0,e)}async listOrgs(t){return this.request("GET","/org",void 0,void 0,t)}async submitMfaCode(t,e){const s={};this.jwt&&(s["X-Access-Token"]=this.jwt);const i=await this.httpClient.fetch("PUT","/session/mfa",{mfaCode:t},{},s,e);await this.completeLogin(i)}async switchOrg(t,e){await this.request("PUT",`/session/org/${t}`,{},void 0,e),this.activeOrgId=t}async getProperties(t){return this.request("GET","/property",void 0,void 0,t)}async getProperty(t,e){var s,i;const a=await this.getProperties(e);return null===(i=null===(s=null==a?void 0:a.payload)||void 0===s?void 0:s.properties)||void 0===i?void 0:i[t]}}exports.ERROR_CODES=e,exports.MendError=t,exports.MendSdk=a,exports.default=a;
