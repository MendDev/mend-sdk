!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).MendSdk={})}(this,(function(t){"use strict";class e extends Error{constructor(t,s,i){super(t),this.name="MendError",this.code=s,this.status=i,Object.setPrototypeOf(this,e.prototype)}}const s={SDK_CONFIG:"SDK_CONFIG",AUTH_MISSING_TOKEN:"AUTH_MISSING_TOKEN",AUTH_MFA_REQUIRED:"AUTH_MFA_REQUIRED",AUTH_INVALID_MFA:"AUTH_INVALID_MFA",ORG_NOT_FOUND:"ORG_NOT_FOUND",HTTP_ERROR:"HTTP_ERROR"};class i{constructor(t){var e;this.apiEndpoint=t.apiEndpoint.replace(/\/$/,""),this.defaultHeaders=null!==(e=t.defaultHeaders)&&void 0!==e?e:{}}async fetch(t,i,a,n={},o={},r){const d=Object.keys(n).length?"?"+new URLSearchParams(n).toString():"",h=this.apiEndpoint+i+d,l={"Content-Type":"application/json",Accept:"application/json",...this.defaultHeaders,...o},c=await fetch(h,{method:t,headers:l,body:a?JSON.stringify(a):void 0,signal:r});if(!c.ok)throw new e(`HTTP ${c.status} â€“ ${c.statusText}`,s.HTTP_ERROR,c.status);const u=await c.text();return u?JSON.parse(u):void 0}}class a{constructor(){this.mutex=Promise.resolve()}async lock(t){let e;const s=new Promise((t=>{e=t})),i=this.mutex;this.mutex=this.mutex.then((()=>s)),await i;try{return await t()}finally{e()}}}class n{constructor(t){var n,o;if(this.authMutex=new a,this.activeOrgId=null,this.availableOrgs=null,this.jwt=null,this.jwtExpiresAt=0,!(null==t?void 0:t.apiEndpoint)||!(null==t?void 0:t.email)||!(null==t?void 0:t.password))throw new e("apiEndpoint, email and password are required",s.SDK_CONFIG);this.httpClient=(o={apiEndpoint:t.apiEndpoint,defaultHeaders:t.defaultHeaders},new i(o)),this.email=t.email,this.password=t.password,this.orgId=t.orgId,this.mfaCode=t.mfaCode,this.tokenTTL=null!==(n=t.tokenTTL)&&void 0!==n?n:55}async authenticate(){const t=await this.httpClient.fetch("POST","/session",{email:this.email,password:this.password},{},{});if(t.token)await this.completeLogin(t);else{if(void 0===this.mfaCode)throw new e("JWT not returned by /session",s.AUTH_MISSING_TOKEN);await this.submitMfaCode(this.mfaCode)}}async completeLogin(t){var i,a;const n=t.token;if(!n)throw new e("JWT not returned by /session",s.AUTH_MISSING_TOKEN);this.jwt=n,this.jwtExpiresAt=Date.now()+6e4*this.tokenTTL;const o=null==t?void 0:t.payload;if(Array.isArray(null==o?void 0:o.orgs)&&(this.availableOrgs=o.orgs),void 0!==this.orgId)await this.switchOrg(this.orgId);else{if(!this.availableOrgs){const t=await this.listOrgs();this.availableOrgs=Array.isArray(null==t?void 0:t.payload)?t.payload:null===(i=null==t?void 0:t.payload)||void 0===i?void 0:i.orgs}if(Array.isArray(this.availableOrgs)&&1===this.availableOrgs.length){const t=this.availableOrgs[0],e=null!==(a=t.id)&&void 0!==a?a:t.orgId;e&&await this.switchOrg(e)}}}async ensureAuth(){this.jwt&&Date.now()<this.jwtExpiresAt||await this.authMutex.lock((async()=>{(!this.jwt||Date.now()>=this.jwtExpiresAt)&&await this.authenticate()}))}async request(t,e,s,i,a){await this.ensureAuth();const n={};return this.jwt&&(n["X-Access-Token"]=this.jwt),this.httpClient.fetch(t,e,s,i||{},n,a)}async getOrg(t,e){return this.request("GET",`/org/${t}`,void 0,void 0,e)}async getUser(t,e){return this.request("GET",`/user/${t}`,void 0,void 0,e)}async searchPatients(t={},e){return this.request("GET","/patient",void 0,t,e)}async getPatient(t,e){return this.request("GET",`/patient/${t}`,void 0,void 0,e)}async getPatientAssessmentScores(t,e){return this.request("GET",`/patient/${t}/assessment-scores`,void 0,void 0,e)}async createPatient(t,e=!1,s){const i=e?"/patient/force":"/patient";return this.request("POST",i,t,void 0,s)}async updatePatient(t,e,s=!1,i){const a=s?`/patient/${t}/force`:`/patient/${t}`;return this.request("PUT",a,e,void 0,i)}async deletePatient(t,e){return this.request("DELETE",`/patient/${t}`,void 0,void 0,e)}async getAppointment(t,e){return this.request("GET",`/appointment/${t}`,void 0,void 0,e)}async createAppointment(t,e){return this.request("POST","/appointment",t,void 0,e)}async listOrgs(t){return this.request("GET","/org",void 0,void 0,t)}async submitMfaCode(t,e){const s={};this.jwt&&(s["X-Access-Token"]=this.jwt);const i=await this.httpClient.fetch("PUT","/session/mfa",{mfaCode:t},{},s,e);await this.completeLogin(i)}async switchOrg(t,e){await this.request("PUT",`/session/org/${t}`,{},void 0,e),this.activeOrgId=t}async getProperties(t){return this.request("GET","/property",void 0,void 0,t)}async getProperty(t,e){var s,i;const a=await this.getProperties(e);return null===(i=null===(s=null==a?void 0:a.payload)||void 0===s?void 0:s.properties)||void 0===i?void 0:i[t]}}t.ERROR_CODES=s,t.MendError=e,t.MendSdk=n,t.default=n,Object.defineProperty(t,"__esModule",{value:!0})}));
